# Dashboard Authoring Platform - Implementation Vision

## ğŸ¯ Project Overview

A multi-dashboard runtime platform with role-based access for dashboard consumption and authoring. Built with SvelteKit, it provides both consumer views and live editing capabilities for dashboard authors.

### Multi-Dashboard Architecture
- **Dashboard Runtime**: Serves multiple dashboards from `/public/dashboards/` directory
- **Role-Based Access**: Authors get editing capabilities, consumers get view-only
- **OAuth Proxy Integration**: Frontend by OAuth proxy that handles authentication and routing
- **Query Delegation**: Data queries routed through OAuth proxy `/query` endpoint

## ğŸ›£ï¸ URL Routing Architecture

### Route Structure
```
/dashboards                    â†’ Landing page with dashboard tiles
/dashboards/{name}             â†’ Consumer view of specific dashboard
/dashboards/{name}/edit        â†’ Author editing interface with live preview
```

### User Roles & Access
- **Dashboard Consumers**: View dashboards at `/dashboards/{name}`
- **Dashboard Authors**: Edit dashboards at `/dashboards/{name}/edit` (wrench icon access)
- **Current Implementation**: Everyone is treated as dashboard author

### OAuth Proxy Integration
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    /dashboards/*    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OAuth Proxy   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Dashboard Runtime   â”‚
â”‚                 â”‚                     â”‚ (SvelteKit App)     â”‚
â”‚   - Auth        â”‚ â†â”€ /query/* â”€â”€â”€â”€â”€â”€â”€ â”‚                     â”‚
â”‚   - Routing     â”‚                     â”‚ - Multi-dashboard   â”‚
â”‚   - Data APIs   â”‚                     â”‚ - Live editing      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Examples
- `/dashboards` â†’ Shows tiles for sales, marketing, operations dashboards
- `/dashboards/sales` â†’ Consumer view of sales dashboard with charts/filters
- `/dashboards/sales/edit` â†’ Live editor for sales dashboard authors
- `/dashboards/marketing` â†’ Consumer view of marketing dashboard
- `/dashboards/marketing/edit` â†’ Live editor for marketing dashboard

## ğŸ—ï¸ Architecture

### Core Technologies
- **SvelteKit + Vite**: Fast development with hot reload
- **ECharts**: JavaScript charting library (direct integration)
- **Runtime Svelte Compilation**: `svelte.compile` for compile-on-save workflow
- **Component Security**: Whitelist system preventing arbitrary imports
- **Intuitive Components**: Semantic naming (BarChart, LineChart, PieChart)
- **Data Architecture**: Store-based with SQL companion files

### Layout Structure
```
â”Œâ”€ Hamburger Menu (floating) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€ Header (filename + save button)            â”‚
â”œâ”€ Save Message (if shown)                    â”‚
â”œâ”€ Editor (50%) â”‚ Live Preview (50%)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Key Components

### 1. App.svelte (Main Layout)
- **Hamburger menu**: Slides in from left, doesn't affect main layout
- **Full viewport usage**: No wasted space when drawer closed
- **Responsive header**: Contains current file path and save functionality
- **50/50 split**: Editor and preview divide full width equally

### 2. SimpleEditor.svelte (Code Editor)
- **Textarea-based**: Replaced Monaco due to integration complexities
- **Dark theme**: VS Code-like styling with syntax highlighting
- **Two-way binding**: Real-time code synchronization
- **Proper sizing**: Takes full available space in layout

### 3. LivePreview.svelte (Real-time Preview)
- **Code parsing**: Extracts chart data, titles, and component visibility
- **Component detection**: Shows/hides charts and filters based on code
- **Data extraction**: Parses arrays and values from code changes
- **Compilation feedback**: Shows success/error status

### 4. Chart.svelte (ECharts Integration)
- **Direct ECharts**: Bypassed svelte-echarts package issues
- **Option updates**: Reactive to data changes
- **Proper cleanup**: Memory management for chart instances
- **Flexible sizing**: Adapts to container dimensions

## ğŸ”’ Security System

### Zero-Script, Input-Based Security (Evidence.dev Pattern)

#### Complete Elimination of Script Blocks
- **NO `<script>` tags allowed** - Zero code execution
- **Input components only** - Parameters via UI components
- **Expression validation** - Only `{inputs.paramName}` patterns allowed
- **SQL parameterization** - Secure query parameter injection

#### Input Component System
```svelte
<!-- Parameters generated by input components -->
<Toggle name="showFilters" label="Show Filters" value="true" />
<Dropdown name="region" options="North,South,East,West" value="North" />
<DateRange name="dateRange" start="2024-01-01" end="2024-12-31" />
<NumberInput name="threshold" label="Threshold" value="100" min="0" max="1000" />

<!-- Display components consume parameters -->
<Grid cols="3" visible="{inputs.showFilters}">
  <Chart 
    type="bar" 
    title="Sales by Region"
    source="sales"
    filter="region={inputs.region} AND value >= {inputs.threshold}"
  />
</Grid>
```

#### Security Benefits
- **Zero code execution** - No JavaScript evaluation possible
- **Parameterized queries** - SQL injection prevention
- **UI-driven state** - All parameters visible in markup
- **Simple validation** - Only check input references, not code
- **Evidence.dev proven** - Battle-tested pattern in production

### Allowed vs Forbidden Patterns

**âœ… Secure Input References:**
```svelte
<Chart visible="{inputs.showCharts}" />
<Grid cols="{inputs.columnCount}" />
<Filter title="Filters for {inputs.region}" />
```

**âŒ Completely Blocked:**
```svelte
<!-- No script blocks at all -->
<script>let anything = true;</script>          

<!-- No complex expressions -->
<Chart visible="{eval(code)}" />
<Chart data="{fetch('/api')}" />
<Chart title="{document.title}" />
```

### AST Parser & Input State System

#### Svelte AST Compilation Pipeline
The security system uses Svelte's built-in AST parser to analyze dashboard code:

```javascript
// svelteASTParser.js - Core security enforcement
export function parseComponentStructure(source) {
  const ast = svelte.parse(source);
  
  // SECURITY CHECK: Reject any script blocks
  if (ast.instance || ast.module) {
    structure.errors.push('Script blocks not allowed. Use input components for parameters.');
    return structure;
  }
  
  // Parse input components (Toggle, Dropdown, etc.)
  // Parse display components (Chart, Grid, etc.)
  // Initialize input state from component attributes
}
```

#### Input State Context System
Input components automatically populate a reactive `inputs` context:

```svelte
<!-- Input components generate state -->
<Toggle name="showCharts" label="Show Charts" value="true" />
<Dropdown name="region" options="North,South,East,West" value="North" />

<!-- Display components consume from inputs context -->
{#if inputs.showCharts}
  <BarChart source="sales" filter="region={inputs.region}" />
{/if}
```

**State Flow:**
1. **AST Parse**: Extract input components and their default values
2. **State Init**: `inputs = { showCharts: true, region: "North" }`
3. **Reactive Context**: Components access `inputs.paramName`
4. **UI Updates**: Toggle changes â†’ state updates â†’ display re-renders

#### Component Communication Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    generates     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input Componentsâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   inputs.*      â”‚
â”‚ - Toggle        â”‚                  â”‚   State Context â”‚
â”‚ - Dropdown      â”‚                  â”‚                 â”‚
â”‚ - DateRange     â”‚                  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ consumes
                                             â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚Display Componentsâ”‚
                                     â”‚ - BarChart      â”‚
                                     â”‚ - LineChart     â”‚
                                     â”‚ - Grid          â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Security Validation Rules
- **Script Block Detection**: `ast.instance || ast.module` â†’ Reject
- **Input Reference Validation**: Only `{inputs.paramName}` patterns allowed
- **Component Whitelist**: Unknown components â†’ Error
- **Expression Safety**: No JavaScript evaluation, only parameter substitution

## ğŸ“Š Data Architecture & Sources

### Intuitive Component Design
Authors use semantic, self-describing components:
```svelte
<BarChart source="monthlySales" title="Sales Performance" />
<LineChart source="userGrowth" title="User Growth Trend" />
<PieChart source="marketShare" title="Market Distribution" />
```

### Data Source Options

#### 1. Named SQL Queries (Primary)
Each dashboard has a companion `.sql` file with named statements:

**File: `dashboards/sales/Overview.sql`**
```sql
-- monthlySales
SELECT month, revenue, target 
FROM sales_data 
WHERE year = 2024
ORDER BY month;

-- userGrowth  
SELECT date, active_users, new_signups
FROM user_metrics
WHERE date >= '2024-01-01';

-- marketShare
SELECT product, percentage, revenue
FROM market_analysis
WHERE quarter = 'Q4';
```

#### 2. Store/State Integration
Data flows through Svelte stores connected to APIs:
```javascript
// stores/salesStore.js
export const monthlySales = writable([]);
export const userGrowth = writable([]);

// Auto-populated from API calls using SQL query names
fetchData('monthlySales').then(data => monthlySales.set(data));
```

#### 3. Inline Data (Testing/Development)
For unit testing or development without backend:
```svelte
<BarChart 
  source="monthlySales" 
  fallback={[
    {month: 'Jan', revenue: 10000},
    {month: 'Feb', revenue: 12000}
  ]}
  title="Sales Performance" 
/>
```

### Data Flow Architecture
```
SQL Companion File â†’ API Endpoint â†’ Svelte Store â†’ Component
     â†“
Named Queries â†’ HTTP Request â†’ Reactive Data â†’ Live Charts
     â†“
"monthlySales" â†’ /api/query/monthlySales â†’ $monthlySales â†’ <BarChart>
```

### Benefits
- **Intuitive Authoring**: `<BarChart>` is clearer than `<Chart type="bar">`
- **Data Separation**: SQL logic separate from presentation logic
- **Flexible Sources**: Real data, stores, or hardcoded for different environments
- **Type Safety**: Named queries provide data contracts
- **Caching**: Store-based architecture enables intelligent caching
- **Testing**: Fallback data allows isolated component testing

## ğŸ’¾ Persistence Layer (`dashboardAPI.js`)

### Save/Load Functionality
- **localStorage simulation**: Mimics S3/filesystem storage
- **Compilation on save**: Validates code before storing
- **Dashboard organization**: Hierarchical structure (dashboard/page)
- **Error handling**: Graceful failure with user feedback

### Data Structure
```javascript
{
  "sales": ["Overview", "Details", "Reports"],
  "marketing": ["Campaigns", "Analytics"],
  "operations": ["Metrics", "Alerts"]
}
```

## ğŸ¨ User Experience

### Workflow
1. **Select Dashboard**: Use hamburger menu to browse dashboards
2. **Edit Code**: Live editor with syntax highlighting
3. **See Changes**: Real-time preview updates as you type
4. **Save Work**: Compile and persist with feedback
5. **Navigate**: Seamless switching between dashboards

### Live Compilation Features
- **Component visibility**: Add/remove charts and filters
- **Data updates**: Change chart values and see immediate results
- **Title changes**: Update chart titles in real-time
- **Filter controls**: Toggle filter visibility with boolean flags
- **Error feedback**: Clear compilation error messages

## ğŸ”„ Real-time Features

### Code â†’ Preview Mapping
- `<Toggle name="showCharts" />` â†’ Creates `inputs.showCharts` parameter
- `<Dropdown name="region" />` â†’ Creates `inputs.region` parameter  
- `<Chart visible="{inputs.showCharts}" />` â†’ Shows/hides based on toggle
- `<Chart filter="region={inputs.region}" />` â†’ Filters data by selection
- `source="queryName"` â†’ Loads data from named SQL query with parameters
- SQL: `WHERE region = '{inputs.region}'` â†’ Parameterized query filtering

### Compilation Pipeline
1. **Code change** â†’ Triggers reactive update
2. **Parse input components** â†’ Extract parameter definitions
3. **Parse display components** â†’ Extract parameter consumption  
4. **Validate input references** â†’ Ensure only `{inputs.*}` patterns
5. **Update preview** â†’ Re-render with resolved parameters
6. **Generate SQL queries** â†’ Inject parameters into named queries

## ğŸ“± Responsive Design

### Layout Behavior
- **Mobile-friendly**: Hamburger menu pattern
- **Full width usage**: No horizontal scrollbars
- **Flexible panels**: Editor/preview adapt to screen size
- **Smooth animations**: Drawer slides with CSS transitions
- **Accessibility**: Keyboard navigation and ARIA labels

## ğŸš€ Performance Optimizations

### Compilation Strategy
- **On-demand parsing**: Only compile when code changes
- **Component caching**: Reuse chart instances where possible
- **Selective updates**: Only re-render changed components
- **Error boundaries**: Isolate compilation failures

### Memory Management
- **Chart cleanup**: Proper ECharts instance disposal
- **Component lifecycle**: Svelte reactive cleanup
- **Event handling**: Prevent memory leaks

## ğŸ”® Future Enhancements

### Potential Improvements
1. **Monaco Editor**: Re-integrate for better authoring experience
2. **Advanced Components**: More chart types and UI elements
3. **Theme System**: Multiple visual themes
4. **Export Options**: Generate static dashboards
5. **Collaboration**: Multi-user editing capabilities
6. **Version Control**: Dashboard history and rollbacks
7. **SQL Query Builder**: Visual interface for creating named queries
8. **Data Catalog**: Browse available data sources and schemas
9. **Real-time Data**: WebSocket integration for live data updates
10. **Performance Monitoring**: Query performance metrics and optimization

### Technical Debt
- **Package integrations**: Resolve svelte-echarts compatibility
- **Testing coverage**: Unit and integration tests
- **Performance monitoring**: Real-time compilation metrics
- **Documentation**: Component API documentation

## ğŸ“‹ Configuration

### Environment Setup
```bash
npm install
npm run dev  # Start development server
```

### Key Dependencies
- `svelte`: Runtime compilation
- `echarts`: Charting library
- `vite`: Build tool and dev server

### File Structure
```
src/
â”œâ”€â”€ App.svelte              # Main layout
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SimpleEditor.svelte # Code editor
â”‚   â”œâ”€â”€ LivePreview.svelte  # Real-time preview
â”‚   â”œâ”€â”€ BarChart.svelte     # Bar chart component
â”‚   â”œâ”€â”€ LineChart.svelte    # Line chart component
â”‚   â”œâ”€â”€ PieChart.svelte     # Pie chart component
â”‚   â”œâ”€â”€ Grid.svelte         # Layout grid
â”‚   â””â”€â”€ Filter.svelte       # Filter controls
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ compileSvelte.js    # Runtime compilation
â”‚   â”œâ”€â”€ componentRegistry.js # Security whitelist
â”‚   â”œâ”€â”€ dashboardAPI.js     # Persistence layer
â”‚   â””â”€â”€ dataStore.js        # Store management & SQL integration
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ salesStore.js       # Sales data stores
â”‚   â””â”€â”€ userStore.js        # User data stores
â””â”€â”€ dashboards/             # Dashboard files + SQL companions
    â”œâ”€â”€ sales/
    â”‚   â”œâ”€â”€ Overview.svelte # Dashboard component
    â”‚   â””â”€â”€ Overview.sql    # Named SQL queries
    â””â”€â”€ marketing/
        â”œâ”€â”€ Campaigns.svelte
        â””â”€â”€ Campaigns.sql
```

## âœ… Implementation Status

### Completed Features
- âœ… Hamburger menu with sliding drawer
- âœ… Full-width layout without wasted space
- âœ… Live code editor with syntax highlighting
- âœ… Real-time preview with component detection
- âœ… Chart integration with ECharts
- âœ… Save/load functionality with localStorage
- âœ… Security constraints with component whitelist
- âœ… Dynamic navigation between dashboards
- âœ… Compilation error handling
- âœ… Responsive design with proper CSS

### Current Limitations
- SimpleEditor instead of Monaco (integration complexity)
- **SECURE AST parsing with validation** âœ… (was: Basic regex parsing)
- localStorage instead of real backend persistence
- Limited component library (Chart, Grid, Filter only)
- **Multi-layer security system** âœ… (prevents script injection)

---

*This platform provides a foundation for secure, real-time dashboard authoring with room for significant enhancement and expansion.*
