# Dashboard Authoring Platform - Implementation Vision

## 🎯 Project Overview

A SvelteKit-based dashboard authoring platform that allows authors to edit `.svelte` files in a live editor with real-time preview, runtime compilation, and security constraints.

## 🏗️ Architecture

### Core Technologies
- **SvelteKit + Vite**: Fast development with hot reload
- **ECharts**: JavaScript charting library (direct integration)
- **Runtime Svelte Compilation**: `svelte.compile` for compile-on-save workflow
- **Component Security**: Whitelist system preventing arbitrary imports
- **Intuitive Components**: Semantic naming (BarChart, LineChart, PieChart)
- **Data Architecture**: Store-based with SQL companion files

### Layout Structure
```
┌─ Hamburger Menu (floating) ──────────────────┐
├─ Header (filename + save button)            │
├─ Save Message (if shown)                    │
├─ Editor (50%) │ Live Preview (50%)          │
└───────────────────────────────────────────────┘
```

## 🔧 Key Components

### 1. App.svelte (Main Layout)
- **Hamburger menu**: Slides in from left, doesn't affect main layout
- **Full viewport usage**: No wasted space when drawer closed
- **Responsive header**: Contains current file path and save functionality
- **50/50 split**: Editor and preview divide full width equally

### 2. SimpleEditor.svelte (Code Editor)
- **Textarea-based**: Replaced Monaco due to integration complexities
- **Dark theme**: VS Code-like styling with syntax highlighting
- **Two-way binding**: Real-time code synchronization
- **Proper sizing**: Takes full available space in layout

### 3. LivePreview.svelte (Real-time Preview)
- **Code parsing**: Extracts chart data, titles, and component visibility
- **Component detection**: Shows/hides charts and filters based on code
- **Data extraction**: Parses arrays and values from code changes
- **Compilation feedback**: Shows success/error status

### 4. Chart.svelte (ECharts Integration)
- **Direct ECharts**: Bypassed svelte-echarts package issues
- **Option updates**: Reactive to data changes
- **Proper cleanup**: Memory management for chart instances
- **Flexible sizing**: Adapts to container dimensions

## 🔒 Security System

### Zero-Script, Input-Based Security (Evidence.dev Pattern)

#### Complete Elimination of Script Blocks
- **NO `<script>` tags allowed** - Zero code execution
- **Input components only** - Parameters via UI components
- **Expression validation** - Only `{inputs.paramName}` patterns allowed
- **SQL parameterization** - Secure query parameter injection

#### Input Component System
```svelte
<!-- Parameters generated by input components -->
<Toggle name="showFilters" label="Show Filters" value="true" />
<Dropdown name="region" options="North,South,East,West" value="North" />
<DateRange name="dateRange" start="2024-01-01" end="2024-12-31" />
<NumberInput name="threshold" label="Threshold" value="100" min="0" max="1000" />

<!-- Display components consume parameters -->
<Grid cols="3" visible="{inputs.showFilters}">
  <Chart 
    type="bar" 
    title="Sales by Region"
    source="sales"
    filter="region={inputs.region} AND value >= {inputs.threshold}"
  />
</Grid>
```

#### Security Benefits
- **Zero code execution** - No JavaScript evaluation possible
- **Parameterized queries** - SQL injection prevention
- **UI-driven state** - All parameters visible in markup
- **Simple validation** - Only check input references, not code
- **Evidence.dev proven** - Battle-tested pattern in production

### Allowed vs Forbidden Patterns

**✅ Secure Input References:**
```svelte
<Chart visible="{inputs.showCharts}" />
<Grid cols="{inputs.columnCount}" />
<Filter title="Filters for {inputs.region}" />
```

**❌ Completely Blocked:**
```svelte
<!-- No script blocks at all -->
<script>let anything = true;</script>          

<!-- No complex expressions -->
<Chart visible="{eval(code)}" />
<Chart data="{fetch('/api')}" />
<Chart title="{document.title}" />
```

## 📊 Data Architecture & Sources

### Intuitive Component Design
Authors use semantic, self-describing components:
```svelte
<BarChart source="monthlySales" title="Sales Performance" />
<LineChart source="userGrowth" title="User Growth Trend" />
<PieChart source="marketShare" title="Market Distribution" />
```

### Data Source Options

#### 1. Named SQL Queries (Primary)
Each dashboard has a companion `.sql` file with named statements:

**File: `dashboards/sales/Overview.sql`**
```sql
-- monthlySales
SELECT month, revenue, target 
FROM sales_data 
WHERE year = 2024
ORDER BY month;

-- userGrowth  
SELECT date, active_users, new_signups
FROM user_metrics
WHERE date >= '2024-01-01';

-- marketShare
SELECT product, percentage, revenue
FROM market_analysis
WHERE quarter = 'Q4';
```

#### 2. Store/State Integration
Data flows through Svelte stores connected to APIs:
```javascript
// stores/salesStore.js
export const monthlySales = writable([]);
export const userGrowth = writable([]);

// Auto-populated from API calls using SQL query names
fetchData('monthlySales').then(data => monthlySales.set(data));
```

#### 3. Inline Data (Testing/Development)
For unit testing or development without backend:
```svelte
<BarChart 
  source="monthlySales" 
  fallback={[
    {month: 'Jan', revenue: 10000},
    {month: 'Feb', revenue: 12000}
  ]}
  title="Sales Performance" 
/>
```

### Data Flow Architecture
```
SQL Companion File → API Endpoint → Svelte Store → Component
     ↓
Named Queries → HTTP Request → Reactive Data → Live Charts
     ↓
"monthlySales" → /api/query/monthlySales → $monthlySales → <BarChart>
```

### Benefits
- **Intuitive Authoring**: `<BarChart>` is clearer than `<Chart type="bar">`
- **Data Separation**: SQL logic separate from presentation logic
- **Flexible Sources**: Real data, stores, or hardcoded for different environments
- **Type Safety**: Named queries provide data contracts
- **Caching**: Store-based architecture enables intelligent caching
- **Testing**: Fallback data allows isolated component testing

## 💾 Persistence Layer (`dashboardAPI.js`)

### Save/Load Functionality
- **localStorage simulation**: Mimics S3/filesystem storage
- **Compilation on save**: Validates code before storing
- **Dashboard organization**: Hierarchical structure (dashboard/page)
- **Error handling**: Graceful failure with user feedback

### Data Structure
```javascript
{
  "sales": ["Overview", "Details", "Reports"],
  "marketing": ["Campaigns", "Analytics"],
  "operations": ["Metrics", "Alerts"]
}
```

## 🎨 User Experience

### Workflow
1. **Select Dashboard**: Use hamburger menu to browse dashboards
2. **Edit Code**: Live editor with syntax highlighting
3. **See Changes**: Real-time preview updates as you type
4. **Save Work**: Compile and persist with feedback
5. **Navigate**: Seamless switching between dashboards

### Live Compilation Features
- **Component visibility**: Add/remove charts and filters
- **Data updates**: Change chart values and see immediate results
- **Title changes**: Update chart titles in real-time
- **Filter controls**: Toggle filter visibility with boolean flags
- **Error feedback**: Clear compilation error messages

## 🔄 Real-time Features

### Code → Preview Mapping
- `<Toggle name="showCharts" />` → Creates `inputs.showCharts` parameter
- `<Dropdown name="region" />` → Creates `inputs.region` parameter  
- `<Chart visible="{inputs.showCharts}" />` → Shows/hides based on toggle
- `<Chart filter="region={inputs.region}" />` → Filters data by selection
- `source="queryName"` → Loads data from named SQL query with parameters
- SQL: `WHERE region = '{inputs.region}'` → Parameterized query filtering

### Compilation Pipeline
1. **Code change** → Triggers reactive update
2. **Parse input components** → Extract parameter definitions
3. **Parse display components** → Extract parameter consumption  
4. **Validate input references** → Ensure only `{inputs.*}` patterns
5. **Update preview** → Re-render with resolved parameters
6. **Generate SQL queries** → Inject parameters into named queries

## 📱 Responsive Design

### Layout Behavior
- **Mobile-friendly**: Hamburger menu pattern
- **Full width usage**: No horizontal scrollbars
- **Flexible panels**: Editor/preview adapt to screen size
- **Smooth animations**: Drawer slides with CSS transitions
- **Accessibility**: Keyboard navigation and ARIA labels

## 🚀 Performance Optimizations

### Compilation Strategy
- **On-demand parsing**: Only compile when code changes
- **Component caching**: Reuse chart instances where possible
- **Selective updates**: Only re-render changed components
- **Error boundaries**: Isolate compilation failures

### Memory Management
- **Chart cleanup**: Proper ECharts instance disposal
- **Component lifecycle**: Svelte reactive cleanup
- **Event handling**: Prevent memory leaks

## 🔮 Future Enhancements

### Potential Improvements
1. **Monaco Editor**: Re-integrate for better authoring experience
2. **Advanced Components**: More chart types and UI elements
3. **Theme System**: Multiple visual themes
4. **Export Options**: Generate static dashboards
5. **Collaboration**: Multi-user editing capabilities
6. **Version Control**: Dashboard history and rollbacks
7. **SQL Query Builder**: Visual interface for creating named queries
8. **Data Catalog**: Browse available data sources and schemas
9. **Real-time Data**: WebSocket integration for live data updates
10. **Performance Monitoring**: Query performance metrics and optimization

### Technical Debt
- **Package integrations**: Resolve svelte-echarts compatibility
- **Testing coverage**: Unit and integration tests
- **Performance monitoring**: Real-time compilation metrics
- **Documentation**: Component API documentation

## 📋 Configuration

### Environment Setup
```bash
npm install
npm run dev  # Start development server
```

### Key Dependencies
- `svelte`: Runtime compilation
- `echarts`: Charting library
- `vite`: Build tool and dev server

### File Structure
```
src/
├── App.svelte              # Main layout
├── components/
│   ├── SimpleEditor.svelte # Code editor
│   ├── LivePreview.svelte  # Real-time preview
│   ├── BarChart.svelte     # Bar chart component
│   ├── LineChart.svelte    # Line chart component
│   ├── PieChart.svelte     # Pie chart component
│   ├── Grid.svelte         # Layout grid
│   └── Filter.svelte       # Filter controls
├── lib/
│   ├── compileSvelte.js    # Runtime compilation
│   ├── componentRegistry.js # Security whitelist
│   ├── dashboardAPI.js     # Persistence layer
│   └── dataStore.js        # Store management & SQL integration
├── stores/
│   ├── salesStore.js       # Sales data stores
│   └── userStore.js        # User data stores
└── dashboards/             # Dashboard files + SQL companions
    ├── sales/
    │   ├── Overview.svelte # Dashboard component
    │   └── Overview.sql    # Named SQL queries
    └── marketing/
        ├── Campaigns.svelte
        └── Campaigns.sql
```

## ✅ Implementation Status

### Completed Features
- ✅ Hamburger menu with sliding drawer
- ✅ Full-width layout without wasted space
- ✅ Live code editor with syntax highlighting
- ✅ Real-time preview with component detection
- ✅ Chart integration with ECharts
- ✅ Save/load functionality with localStorage
- ✅ Security constraints with component whitelist
- ✅ Dynamic navigation between dashboards
- ✅ Compilation error handling
- ✅ Responsive design with proper CSS

### Current Limitations
- SimpleEditor instead of Monaco (integration complexity)
- **SECURE AST parsing with validation** ✅ (was: Basic regex parsing)
- localStorage instead of real backend persistence
- Limited component library (Chart, Grid, Filter only)
- **Multi-layer security system** ✅ (prevents script injection)

---

*This platform provides a foundation for secure, real-time dashboard authoring with room for significant enhancement and expansion.*
